<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="CapitalApp" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#7b2cff" />

<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1vdmltZW50YcOnw6NvIGRlIENhcGl0YWwiLAogICJzaG9ydF9uYW1lIjogIkNhcGl0YWxBcHAiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZjlmaCIsCiAgInRoZW1lX2NvbG9yIjogIiM3YjJjZmYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yNDg5LzI0ODk3MTgucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

<title>Capital App - Gestão</title>
<style>
  :root {
    --roxo: #7b2cff; --roxo-claro: #f3edff; --roxo-escuro: #5b12cc;
    --amarelo: #ffdf37; --fundo: #f8f9fd; --card: #ffffff; --linha: #e0d4ff; 
    --radius: 20px; --shadow: 0 10px 30px rgba(123, 44, 255, 0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  body { 
    margin: 0; font-family: 'Inter', -apple-system, sans-serif; 
    background: var(--fundo); color: #1a1a1a;
    padding-top: env(safe-area-inset-top);
    padding-bottom: 40px;
  }

  #bannerInstalacao {
    display: none; background: var(--amarelo); padding: 15px;
    text-align: center; font-weight: 800; border-bottom: 2px solid #eec900;
    position: sticky; top: 0; z-index: 999; cursor: pointer;
  }

  .tabs { display: flex; background: #fff; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: 800; color: #aaa; font-size: 13px; text-transform: uppercase; border-bottom: 3px solid transparent; }
  .tab-btn.active { color: var(--roxo); border-bottom-color: var(--roxo); }

  .view-section { display: none; padding: 15px; }
  .view-section.active { display: block; }

  .container { background: var(--card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--linha); }
  h2 { text-align: center; color: var(--roxo); margin: 0 0 20px; font-size: 20px; text-transform: uppercase; }

  .field { margin-bottom: 15px; }
  label { font-size: 11px; font-weight: 800; color: var(--roxo); margin-bottom: 6px; display: block; text-transform: uppercase; }
  input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #eee; font-size: 16px; background: #fdfdfd; }

  .btn-main { width: 100%; background: var(--roxo); color: white; padding: 16px; border-radius: 15px; border: none; font-weight: 800; font-size: 16px; cursor: pointer; margin-top: 10px; }

  /* CARROSSEL DE CARDS - PRIORIDADE NO TOPO */
  .slider-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 10px 5px 25px; scrollbar-width: none; }
  .slider-container::-webkit-scrollbar { display: none; }
  .card-investidor { flex: 0 0 88%; scroll-snap-align: center; background: white; border-radius: var(--radius); border: 1.5px solid var(--linha); padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 8px; }
  
  .card-header { font-weight: 900; color: var(--roxo); border-bottom: 1px solid #eee; padding-bottom: 8px; font-size: 16px; text-transform: uppercase; }
  .info-row { display: flex; justify-content: space-between; font-size: 13px; padding: 2px 0; border-bottom: 1px dotted #f0f0f0; }
  .info-row span { color: #666; font-weight: 600; }
  .info-row b { color: #333; }

  .margem-box { background: var(--roxo-claro); padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin: 8px 0; }
  .btn-pago { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; margin-bottom: 8px; }
  .pago { background: #2ecc71; color: white; }
  .nao-pago { background: #e74c3c; color: white; }
  
  .card-actions { display: flex; gap: 10px; }
  .btn-edit { flex: 1; background: #3498db; color: white; padding: 12px; border-radius: 10px; border: none; font-weight: 700; }
  .btn-del { flex: 1; background: #f2f2f2; color: #666; padding: 12px; border-radius: 10px; border: none; font-weight: 700; }

  /* FILTROS E TOTAL - ABAIXO DOS CARDS */
  .filtro-card { border: 2px solid var(--roxo); padding: 15px; border-radius: var(--radius); background: #fff; margin-top: 10px; }
  .total-card { background: var(--roxo); color: white; padding: 18px; border-radius: 15px; text-align: center; margin: 15px 0; box-shadow: 0 5px 15px rgba(123, 44, 255, 0.3); }

  /* POPUP CALENDARIO */
  .popup-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
  .popup-cal { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 380px; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
  .cal-day { padding: 12px 5px; border-radius: 10px; font-size: 13px; cursor: pointer; border: 1px solid #eee; text-align: center; }
  .cal-day.selected { background: var(--roxo) !important; color: white !important; }
  
  /* Botão Mês Inteiro Roxo */
  #btnSelMes { background: var(--roxo); color: white; }

  .footer-btns { display: flex; gap: 10px; padding: 15px; margin-top: 10px; }
  .btn-system { flex: 1; background: #333; color: #fff; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 12px; text-transform: uppercase; }
</style>
</head>
<body>

<div id="bannerInstalacao" onclick="instalarApp()">
  ✨ CLIQUE AQUI PARA INSTALAR O APP ✨
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('add', event)">Adicionar</button>
  <button class="tab-btn" onclick="switchTab('list', event)">Visualizar</button>
</div>

<section id="tab-add" class="view-section active">
  <div class="container">
    <h2>Novo Registro</h2>
    <div class="field"><label>Data Entrada</label><input id="dataEntrada" type="text" readonly placeholder="Selecionar data"></div>
    <div class="field"><label>Data Saída</label><input id="dataSaida" type="text" readonly placeholder="Selecionar data"></div>
    <div class="field"><label>Carro</label><input id="carro" type="text"></div>
    <div class="field"><label>Cliente</label><input id="cliente" type="text"></div>
    <div class="field"><label>Placa</label><input id="placa" type="text"></div>
    <div class="field"><label>Fornecedor</label><input id="fornecedor" type="text"></div>
    <div class="field"><label>Valor Compra</label><input id="valorCompra" type="number" step="0.01"></div>
    <div class="field"><label>Valor Venda</label><input id="valorVenda" type="number" step="0.01"></div>
    <button id="btnAdd" class="btn-main" onclick="handleSave()">Salvar Registro</button>
  </div>
</section>

<section id="tab-list" class="view-section">
  <div id="sliderMobile" class="slider-container"></div>

  <div class="filtro-card">
    <label>Filtrar Período ou Dia</label>
    <input id="filtroData" type="text" readonly placeholder="Toque para selecionar...">
    
    <label style="margin-top:15px">Filtrar por Status</label>
    <select id="filtroStatus" onchange="aplicarFiltros()">
      <option value="">Todos os Status</option>
      <option value="pago">Pagos</option>
      <option value="nao">Não Pagos</option>
    </select>

    <div class="total-card">
      <span style="font-size:11px; font-weight:700; opacity:0.9">LUCRO ACUMULADO (40%)</span>
      <span id="totalMargem" style="display:block; font-size:24px; font-weight:900; margin-top:5px">R$ 0,00</span>
    </div>
    
    <button onclick="limparFiltros()" class="btn-del" style="width:100%; background:#666; color:#fff; border-radius:12px">Limpar Todos os Filtros</button>
  </div>

  <div class="footer-btns">
    <button onclick="fazerBackup()" class="btn-system">Exportar Backup</button>
    <button onclick="importarDados()" class="btn-system">Importar Dados</button>
  </div>
</section>

<div id="popupBg" class="popup-bg">
  <div class="popup-cal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center">
      <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:20px; color:var(--roxo)">◀</button>
      <div id="calTitulo" style="font-weight:900; color:var(--roxo-escuro)"></div>
      <button onclick="changeMonth(1)" style="border:none; background:none; font-size:20px; color:var(--roxo)">▶</button>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:15px">
      <button id="btnSelMes" class="btn-edit" style="font-size:11px; flex:1">Mês Inteiro</button>
      <button id="btnSelPeriodo" class="btn-edit" style="font-size:11px; background:#444; flex:1">Modo Período</button>
    </div>
    <div id="calGrid" class="cal-grid"></div>
    <div style="margin-top:20px; display:flex; gap:10px">
      <button onclick="fecharCalendario()" class="btn-del" style="flex:1">Sair</button>
      <button onclick="confirmarData()" class="btn-main" style="flex:1; margin:0; padding:12px">Aplicar</button>
    </div>
  </div>
</div>

<script>
/* REGISTRO DE SERVICE WORKER (PWA) */
if ('serviceWorker' in navigator) {
  const swCode = `self.addEventListener('install', e => self.skipWaiting()); self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));`;
  const blob = new Blob([swCode], {type: 'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('bannerInstalacao').style.display = 'block';
});

function instalarApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choice) => {
      if (choice.outcome === 'accepted') document.getElementById('bannerInstalacao').style.display = 'none';
      deferredPrompt = null;
    });
  }
}

/* SISTEMA */
const STORAGE_KEY = "registros_capital_v4";
let registros = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
let editIndex = null;
let calViewDate = new Date();
let selectedDates = [];
let rangeStart = null;
let currentTargetInput = null;
let isRangeMode = false;

function switchTab(tab, e) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
  if(e) e.currentTarget.classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
  if(tab === 'list') aplicarFiltros();
}

function handleSave() {
  const c = Number(document.getElementById("valorCompra").value);
  const v = Number(document.getElementById("valorVenda").value);
  const m = Number(((v - c) * 0.40).toFixed(2));
  
  const novo = {
    dataEntrada: parseDateToIso(document.getElementById("dataEntrada").value),
    dataSaida: parseDateToIso(document.getElementById("dataSaida").value),
    carro: document.getElementById("carro").value || "",
    cliente: document.getElementById("cliente").value || "",
    placa: document.getElementById("placa").value || "",
    fornecedor: document.getElementById("fornecedor").value || "",
    valorCompra: c, 
    valorVenda: v, 
    margem: m,
    pago: editIndex !== null ? registros[editIndex].pago : false
  };

  if(editIndex !== null) registros[editIndex] = novo; 
  else registros.push(novo);

  localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
  limparForm(); switchTab('list');
}

function aplicarFiltros() {
  const status = document.getElementById("filtroStatus").value;
  let filtrados = registros.filter(r => {
    const mStatus = status === "" || (status === "pago" ? r.pago : !r.pago);
    const mData = selectedDates.length === 0 || selectedDates.includes(r.dataEntrada);
    return mStatus && mData;
  });

  document.getElementById("totalMargem").innerText = "R$ " + (filtrados.reduce((a, b) => a + b.margem, 0)).toLocaleString('pt-BR', {minimumFractionDigits:2});
  
  const slider = document.getElementById("sliderMobile");
  slider.innerHTML = filtrados.length ? "" : "<p style='width:100%; text-align:center; color:#999; padding:40px 0'>Nenhum registro para este filtro.</p>";
  
  filtrados.forEach((r, i) => {
    const idx = registros.indexOf(r);
    slider.innerHTML += `
    <div class="card-investidor">
      <div class="card-header">${r.carro || 'SEM NOME'}</div>
      <div class="info-row"><span>Entrada</span><b>${formatDateIso(r.dataEntrada) || '---'}</b></div>
      <div class="info-row"><span>Saída</span><b>${formatDateIso(r.dataSaida) || '---'}</b></div>
      <div class="info-row"><span>Placa</span><b>${r.placa || '---'}</b></div>
      <div class="info-row"><span>Cliente</span><b>${r.cliente || '---'}</b></div>
      <div class="info-row"><span>Fornecedor</span><b>${r.fornecedor || '---'}</b></div>
      <div class="info-row"><span>Valor Compra</span><b>R$ ${r.valorCompra.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b></div>
      <div class="info-row"><span>Valor Venda</span><b>R$ ${r.valorVenda.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b></div>
      
      <div class="margem-box">
        <span style="font-size:11px; font-weight:700; color:var(--roxo-escuro)">LUCRO (40%)</span>
        <b style="color:var(--roxo); font-size:18px">R$ ${r.margem.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b>
      </div>
      
      <button class="btn-pago ${r.pago?'pago':'nao-pago'}" onclick="togglePago(${idx})">${r.pago?'PAGO':'NÃO PAGO'}</button>
      
      <div class="card-actions">
        <button class="btn-edit" onclick="prepararEdicao(${idx})">EDITAR</button>
        <button class="btn-del" onclick="excluirRegistro(${idx})">EXCLUIR</button>
      </div>
    </div>`;
  });
}

/* CALENDÁRIO */
function renderCalendario() {
  const grid = document.getElementById("calGrid"); grid.innerHTML = "";
  document.getElementById("calTitulo").innerText = `${calViewDate.getMonth()+1} / ${calViewDate.getFullYear()}`;
  const prim = new Date(calViewDate.getFullYear(), calViewDate.getMonth(), 1).getDay();
  const ult = new Date(calViewDate.getFullYear(), calViewDate.getMonth()+1, 0).getDate();
  for(let i=0; i<prim; i++) grid.innerHTML += `<div></div>`;
  for(let d=1; d<=ult; d++) {
    const iso = `${calViewDate.getFullYear()}-${String(calViewDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    grid.innerHTML += `<div class="cal-day ${selectedDates.includes(iso)?'selected':''}" onclick="cliqueDia('${iso}')">${d}</div>`;
  }
}

function cliqueDia(iso) {
  if(!isRangeMode) selectedDates = [iso];
  else if(!rangeStart) { rangeStart = iso; selectedDates = [iso]; }
  else {
    let s = new Date(rangeStart + "T00:00:00"), e = new Date(iso + "T00:00:00"); 
    if(s > e) [s, e] = [e, s];
    selectedDates = []; while(s <= e) { selectedDates.push(s.toISOString().split('T')[0]); s.setDate(s.getDate()+1); }
    rangeStart = null;
  }
  renderCalendario();
}

document.getElementById("btnSelMes").onclick = () => {
  const y = calViewDate.getFullYear(), m = calViewDate.getMonth(), ult = new Date(y, m+1, 0).getDate();
  selectedDates = []; for(let i=1; i<=ult; i++) selectedDates.push(`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`);
  renderCalendario();
};

document.getElementById("btnSelPeriodo").onclick = (e) => { 
  isRangeMode = !isRangeMode; 
  e.target.style.background = isRangeMode ? "var(--roxo-escuro)" : "#444"; 
  rangeStart = null; 
};

function confirmarData() {
  if(selectedDates.length > 0) {
    if(currentTargetInput.id === "filtroData") {
       currentTargetInput.value = selectedDates.length > 1 ? "Período Selecionado" : formatDateIso(selectedDates[0]);
    } else {
       currentTargetInput.value = formatDateIso(selectedDates[0]);
    }
  }
  fecharCalendario(); aplicarFiltros();
}

/* AUXILIARES */
const formatDateIso = (iso) => { if(!iso) return ""; const [y,m,d] = iso.split("-"); return `${d}/${m}/${y}`; };
const parseDateToIso = (br) => { if(!br) return ""; const [d,m,y] = br.split("/"); return `${y}-${m}-${d}`; };
const changeMonth = (v) => { calViewDate.setMonth(calViewDate.getMonth()+v); renderCalendario(); };
const fecharCalendario = () => document.getElementById("popupBg").style.display = "none";

function limparForm() { 
  editIndex = null; 
  document.querySelectorAll('#tab-add input').forEach(i => i.value = ""); 
  document.getElementById("btnAdd").innerText = "Salvar Registro"; 
}

function togglePago(i) { 
  registros[i].pago = !registros[i].pago; 
  localStorage.setItem(STORAGE_KEY, JSON.stringify(registros)); 
  aplicarFiltros(); 
}

function excluirRegistro(i) { 
  if(confirm("Excluir este registro permanentemente?")) { 
    registros.splice(i,1); 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(registros)); 
    aplicarFiltros(); 
  } 
}

function prepararEdicao(idx) { 
  editIndex = idx; const r = registros[idx];
  document.getElementById("dataEntrada").value = formatDateIso(r.dataEntrada);
  document.getElementById("dataSaida").value = formatDateIso(r.dataSaida);
  document.getElementById("carro").value = r.carro; document.getElementById("cliente").value = r.cliente;
  document.getElementById("placa").value = r.placa; document.getElementById("fornecedor").value = r.fornecedor;
  document.getElementById("valorCompra").value = r.valorCompra; document.getElementById("valorVenda").value = r.valorVenda;
  document.getElementById("btnAdd").innerText = "Atualizar Registro"; switchTab('add');
}

function limparFiltros() { 
  selectedDates = []; 
  document.getElementById("filtroData").value = ""; 
  document.getElementById("filtroStatus").value = ""; // Limpa o status também
  aplicarFiltros(); 
}

function fazerBackup() { 
  const blob = new Blob([JSON.stringify(registros, null, 2)], {type:"application/json"}); 
  const a = document.createElement("a"); 
  a.href = URL.createObjectURL(blob); a.download="backup_capital.json"; a.click(); 
}

function importarDados() { 
  const inp = document.createElement("input"); inp.type="file"; 
  inp.onchange=(e)=>{ 
    const fr=new FileReader(); 
    fr.onload=(ev)=>{ 
      try {
        const data = JSON.parse(ev.target.result);
        if(Array.isArray(data)) {
           registros = data;
           localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
           aplicarFiltros();
           alert("Dados importados com sucesso!");
        }
      } catch(err) { alert("Arquivo JSON inválido."); }
    }; 
    fr.readAsText(e.target.files[0]); 
  }; 
  inp.click(); 
}

document.getElementById("dataEntrada").onclick = (e) => { isRangeMode = false; currentTargetInput = e.target; document.getElementById("popupBg").style.display = "flex"; renderCalendario(); };
document.getElementById("dataSaida").onclick = (e) => { isRangeMode = false; currentTargetInput = e.target; document.getElementById("popupBg").style.display = "flex"; renderCalendario(); };
document.getElementById("filtroData").onclick = (e) => { currentTargetInput = e.target; document.getElementById("popupBg").style.display = "flex"; renderCalendario(); };

aplicarFiltros();
</script>
</body>
</html>
